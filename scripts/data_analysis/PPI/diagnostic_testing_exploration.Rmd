---
title: "ngs_archetype_exploration"
output: html_document
author: Kaitlyn Johnson
date: 11-17-2021
description: takes ngs capacity mapping metrics and does exploratory data analysis on the new metrics and computes summary statistics on the archetypes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(tidyverse) # data wrangling
library(tibble) # data wrangling
library(janitor) # column naming
library(countrycode) # country codes
library(lubridate) # date times
library(readxl) # excel import
library(zoo) # calculate rolling averages
library(R.utils) # R utilities
library(stringr) # to parse strings in R
library(tsoutliers) # remove outliers
library(dplyr) # data wrangling
library(cowplot)
library(car)
library(rgdal)
 
theme_set(theme_cowplot())
ggplot + background_grid(major = "xy", minor = "xy")
FIND_MAP_PATH<-'../data/find_map.csv'
OLD_FIND_MAP_PATH<-url("https://raw.githubusercontent.com/PandemicPreventionInstitute/NGS-Capacity-map/main/data/LMIC%20centered%20map/NGS_flourish_file_11.9.2021_TEST3.csv")
LMIC_LIST_PATH<-'../data/list_of_LMICS.csv'


```
Read in data
```{r}
find_df<-read.csv(FIND_MAP_PATH) 
old_find_df<-read.csv(OLD_FIND_MAP_PATH)
LMICs_df<-read.csv(LMIC_LIST_PATH)
LMICs_df<-LMICs_df%>%mutate(
  code = countrycode(LMICs, origin = 'country.name', destination = 'iso3c')
)%>%select(code)

# order the archetypes
find_df$archetype_clean<-factor(find_df$archetype_clean, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))

max_test_cap_all_countries<-max(find_df$max_new_tests_cap_avg, na.rm = TRUE)
old_find_df<-old_find_df%>% select(code, archetype_full, max_new_tests_cap_avg, dx_testing_capacity)%>%
  rename(old_max_new_tests_cap_avg = max_new_tests_cap_avg,
         old_dx_testing_capacity = dx_testing_capacity,
         old_archetype = archetype_full)
# Make a data frame with country and new and old metrics for diagnostic capacity 
test_df<-left_join(find_df, old_find_df, by = "code")
# Subset to only LMICs!
test_df<-left_join(LMICs_df, test_df, by = "code")

countries_w_missing_data<-test_df%>%filter(max_new_tests_cap_avg==0 | is.na(max_new_tests_cap_avg) | 
                                  cases_in_last_90_days==0 | is.na(cases_in_last_90_days) |
                                  max_new_seq_cap_avg==0 | is.na(max_new_seq_cap_avg))
write.csv(countries_w_missing_data, '../data/countries_w_missing_data.csv')


                                       
# test_df<-test_df%>%
#   select(country, code, ngs_capacity, who_testing_capacity, dx_testing_capacity, max_new_tests_cap_avg,
#          tpr_90_days, cases_in_last_90_days, tests_in_last_90_days, old_max_new_tests_cap_avg, old_dx_testing_capacity, old_archetype, population_size)
# replace NAs with 0s
test_df$max_new_tests_cap_avg[is.na(test_df$max_new_tests_cap_avg)]<-0
#test_df$tpr_90_days[is.na(test_df$tpr_90_days)]<-1
test_df<-distinct(test_df)

countries_w_no_testing<-test_df%>%filter(max_new_tests_cap_avg==0 | is.na(max_new_tests_cap_avg))
countries_w_no_seq<-test_df%>%filter(max_new_seq_cap_avg==0 | is.na(max_new_seq_cap_avg))
countries_w_no_cases<-test_df%>%filter(cases_in_last_90_days==0 | is.na(cases_in_last_90_days))
                                     
```


A look at the old archetypes
```{r}

test_arch<-ggplot(test_df) + geom_violin(aes(x = factor(old_dx_testing_capacity), y = tpr_90_days), fill = "cornflowerblue") +
    #scale_y_log10()+
    coord_cartesian(ylim = c(0,1))+
    geom_jitter(aes(x = factor(old_dx_testing_capacity), y = tpr_90_days, color = who_testing_capacity), height = 0, width = 0.4)+
    ylab('Test positivity past 90 days') + xlab('Old testing capacity designation ') + labs(color = "WHO testing capacity")
test_arch


test_arch2<-ggplot(test_df) + geom_violin(aes(x = factor(old_dx_testing_capacity), y = old_max_new_tests_cap_avg), fill = "darkred") +
  scale_y_log10()+
    geom_jitter(aes(x = factor(old_dx_testing_capacity), y =old_max_new_tests_cap_avg, color = who_testing_capacity), height = 0, width = 0.4)+
  geom_hline(yintercept = 50, linetype = "dashed")+
    ylab('Old maximum of 30-day average tests per 100k') + xlab('Old testing capacity designation')+
  labs(color = "WHO testing capacity")
test_arch2

test_arch2<-ggplot(test_df) + geom_violin(aes(x = factor(old_dx_testing_capacity), y = max_new_tests_cap_avg), fill = "magenta4") +
  scale_y_log10()+
    geom_jitter(aes(x = factor(old_dx_testing_capacity), y =max_new_tests_cap_avg, color = who_testing_capacity), height = 0, width = 0.4)+
    ylab('Maximum of 30-day average tests per 100k') + xlab('Old testing capacity designation')+
  labs(color = "WHO testing capacity")
test_arch2
```
Make some new archetypes
```{r}
# Summary stats on old testing archetypes 
old_summary<-test_df%>%group_by(old_dx_testing_capacity)%>%
  summarise(n_countries = n(),
            median_tpr_90_days = median(tpr_90_days, na.rm = TRUE),
            median_max_new_tests_cap = median(max_new_tests_cap_avg, na.rm = TRUE),
            median_old_max_new_tests_cap = median(old_max_new_tests_cap_avg, na.rm = TRUE)
            )%>%
  mutate(percent_of_countries = n_countries/sum(n_countries))
# find quartiles of max new tests cap avg
probs = c(0.25, 0.33, 0.5, 0.67, 0.75)
quartiles<- quantile(test_df$max_new_tests_cap_avg, probs = probs, na.rm = TRUE)
quartiles_tpr<-quantile(test_df$tpr_90_days, probs = probs, na.rm = TRUE)
# Make new archetype using the lower quartile

# Do without the WHO reliable test as a way of moving countries without data out.
test_df<-test_df%>%mutate(
  max_cap_dx_testing_capacity = case_when(
  max_new_tests_cap_avg>= quartiles[1] ~ "Reliable testing capacity",
  TRUE ~ "Unreliable testing capacity"
  )
)

# Allow countries to be in reliable if they have WHO reliable testing designation, but make stricter
test_df<-test_df%>%mutate(
  who_max_cap_dx_testing_capacity = case_when(
    max_new_tests_cap_avg>= quartiles[2] ~ "Reliable testing capacity",
    ((max_new_tests_cap_avg == 0) & (who_testing_capacity == "1 - Reliable")) ~ "Reliable testing capacity",
    TRUE ~ "Unreliable testing capacity"
  )
)

# create hierarchical testing designation 
test_df<-test_df%>%mutate(
  who_tpr_dx_testing_capacity = case_when(
    tpr_90_days<= quartiles_tpr[5] ~ "Reliable testing capacity",
    ((is.na(tpr_90_days)) & (who_testing_capacity == "1 - Reliable")) ~ "Reliable testing capacity",
    TRUE ~ "Unreliable testing capacity"
  )
)

```

```{r}

test_df<-test_df%>%mutate(
    mismatch = case_when(
      (who_tpr_dx_testing_capacity == "Reliable testing capacity" & old_dx_testing_capacity == "Unreliable testing capacity") ~"Unreliable->reliable",
       (who_tpr_dx_testing_capacity == "Unreliable testing capacity" & old_dx_testing_capacity == "Reliable testing capacity") ~"Reliable->unreliable",
       (who_tpr_dx_testing_capacity == "Reliable testing capacity" & old_dx_testing_capacity == "Reliable testing capacity") ~"Consistently reliable",
       (who_tpr_dx_testing_capacity == "Unreliable testing capacity" & old_dx_testing_capacity == "Unreliable testing capacity") ~"Consistently unreliable"
    )
  )

rel_to_unrel<-test_df%>%filter(mismatch == "Reliable->unreliable")
unrel_to_rel<-test_df%>%filter(mismatch == "Unreliable->reliable")
write.csv(rel_to_unrel, '../data/rel_to_unrel_countries_who_tpr.csv')
write.csv(unrel_to_rel, '../data/unrel_to_rel_countries_who_tpr.csv')

write.csv(test_df, '../data/LMIC_test_stats_by_country.csv')

#test_df<-test_df$who_testing_capacity<-factor(test_df$who_testing_capacity, ordered = TRUE, stringr::str_wrap(c("1 - #Reliable", "0 - Unreliable")))

#test_df<-test_df$new_dx_testing_capacity<-factor(test_df$new_dx_testing_capacity, ordered = TRUE, #stringr::str_wrap(c("Reliable testing capacity", "Unreliable testing capacity")))

check<-test_df%>%filter(who_max_cap_dx_testing_capacity == "Unreliable testing capacity")
check2<-test_df%>%filter(who_tpr_dx_testing_capacity == "Unreliable testing capacity")


max_cap_summary<-test_df%>%group_by(max_cap_dx_testing_capacity)%>%
  summarise(n_countries = n(),
            median_tpr_90_days = median(tpr_90_days, na.rm = TRUE),
            median_max_new_tests_cap = median(max_new_tests_cap_avg, na.rm = TRUE),
            median_old_max_new_tests_cap = median(old_max_new_tests_cap_avg, na.rm = TRUE)
            )%>%
  mutate(percent_of_countries = n_countries/sum(n_countries))

who_max_cap_summary<-test_df%>%group_by(who_max_cap_dx_testing_capacity)%>%
  summarise(n_countries = n(),
            median_tpr_90_days = median(tpr_90_days, na.rm = TRUE),
            median_max_new_tests_cap = median(max_new_tests_cap_avg, na.rm = TRUE),
            median_old_max_new_tests_cap = median(old_max_new_tests_cap_avg, na.rm = TRUE)
            )%>%
  mutate(percent_of_countries = n_countries/sum(n_countries))

new_tpr_summary<-test_df%>%group_by(who_tpr_dx_testing_capacity)%>%
  summarise(n_countries = n(),
            median_tpr_90_days = median(tpr_90_days, na.rm = TRUE),
            median_max_new_tests_cap = median(max_new_tests_cap_avg, na.rm = TRUE),
            median_old_max_new_tests_cap = median(old_max_new_tests_cap_avg, na.rm = TRUE)
            )%>%
  mutate(percent_of_countries = n_countries/sum(n_countries))


test_arch2<-ggplot(test_df) + geom_violin(aes(x = factor(who_tpr_dx_testing_capacity), y = max_new_tests_cap_avg), fill = "magenta4") +
  scale_y_log10()+
    geom_jitter(aes(x = factor(who_tpr_dx_testing_capacity), y =max_new_tests_cap_avg, color = who_testing_capacity), height = 0, width = 0.4)+
  geom_hline(yintercept = quartiles[3], linetype = "dashed")+
    ylab('Maximum of 30-day average tests per 100k') + xlab('New testing capacity designation w/ TPR & WHO')+
  labs(color = "WHO testing capacity")
test_arch2

test_arch2<-ggplot(test_df) + geom_violin(aes(x = factor(who_tpr_dx_testing_capacity), y = tpr_90_days), fill = "cornflowerblue") +
  #scale_y_log10()+
  coord_cartesian(ylim = c(0,1))+
    geom_jitter(aes(x = factor(who_tpr_dx_testing_capacity), y =tpr_90_days, color = who_testing_capacity), height = 0, width = 0.4)+
  geom_hline(yintercept = quartiles_tpr[5], linetype = "dashed")+
    ylab('Test positivity past 90 days') + xlab('Testing capacity designation w/ TPR and WHO')+
  labs(color = "WHO testing capacity")
test_arch2



test_arch2<-ggplot(test_df) + geom_violin(aes(x = factor(max_cap_dx_testing_capacity), y = max_new_tests_cap_avg), fill = "magenta4") +
  scale_y_log10()+
    geom_jitter(aes(x = factor(max_cap_dx_testing_capacity), y =max_new_tests_cap_avg, color = who_testing_capacity), height = 0, width = 0.4)+
  geom_hline(yintercept = quartiles[1], linetype = "dashed")+
    ylab('Maximum of 30-day average tests per 100k') + xlab('Max testing capacity designation')+
  labs(color = "WHO testing capacity")
test_arch2

test_arch2<-ggplot(test_df) + geom_violin(aes(x = factor(who_max_cap_dx_testing_capacity), y = max_new_tests_cap_avg), fill = "magenta4") +
  scale_y_log10()+
    geom_jitter(aes(x = factor(who_max_cap_dx_testing_capacity), y =max_new_tests_cap_avg, color = who_testing_capacity), height = 0, width = 0.4)+
  geom_hline(yintercept = quartiles[2], linetype = "dashed")+
    ylab('Maximum of 30-day average tests per 100k') + xlab('Max testing capacity designation w/ WHO')+
  labs(color = "WHO testing capacity")
test_arch2


test_arch<-ggplot(test_df) + geom_violin(aes(x = factor(who_testing_capacity), y = tpr_90_days), fill = "cornflowerblue") +
    #scale_y_log10()+
  coord_cartesian(ylim = c(0,1))+
    geom_jitter(aes(x = factor(who_testing_capacity), y = tpr_90_days), height = 0, width = 0.4)+
    ylab('Test positivity past 90 days') + xlab('WHO testing capacity ')
test_arch
find_df$archetype_clean<-factor(find_df$archetype_clean, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))


test_arch<-ggplot(test_df) + geom_violin(aes(x = factor(who_testing_capacity), y = max_new_tests_cap_avg), fill = "magenta4") +
    scale_y_log10()+
    geom_hline(yintercept = quartiles[3], linetype = "dashed")+
    geom_jitter(aes(x = factor(who_testing_capacity), y = max_new_tests_cap_avg), height = 0, width = 0.4)+
    ylab('Maximum of 30 day average of tests per 100k') + xlab('WHO testing capacity ')
test_arch
```
Scatterplot comparing metrics
```{r}
pct_seq_v_tpr<-ggplot(test_df) + geom_point(aes(y = tpr_90_days, x = max_new_tests_cap_avg, color = factor(who_testing_capacity),shape = who_tpr_dx_testing_capacity))+
    scale_x_log10()+
    geom_vline(xintercept = quartiles[2], linetype = "dashed")+
    geom_hline(yintercept = quartiles_tpr[5], linetype = "dashed") +
    coord_cartesian(ylim = c(0, 1))+
    xlab('Maximum of 30-day average of testing per 100k') + 
  ylab('Test positivity past 90 days')+ labs(shape = "TPR testing capacity", color = "WHO testing capacity")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_tpr
```
Lowest and highest maximum testing capacity
```{r}
test_df<-test_df[order(-test_df$max_new_tests_cap_avg),]
test_df<-test_df%>%filter(!max_new_tests_cap_avg ==0)
test_df$country<-factor(test_df$country, ordered = TRUE)
test_df_upper<-test_df[1:25,]
test_df_lower<-test_df[(nrow(test_df)-25):nrow(test_df),]
test_df_upper$country <- factor(test_df_upper$country, levels = test_df_upper$country[order(test_df_upper$max_new_tests_cap_avg)])
test_df_lower$country <- factor(test_df_lower$country, levels = test_df_lower$country[order(test_df_lower$max_new_tests_cap_avg)])

bar_max_cap<-ggplot(test_df_upper) + geom_bar(aes(x =country, y = max_new_tests_cap_avg, fill = who_testing_capacity), stat = "identity", position = "dodge") + 
  ylab('Maximum of 30-day average tests per 100k')+xlab('Country')+
  theme(axis.text.x = element_text(angle = 90)) + coord_flip() + ggtitle('Best 25 LMICs Test capacity') + labs(fill = "WHO testing capacity")
bar_max_cap

bar_max_cap<-ggplot(test_df_lower) + geom_bar(aes(x =country, y = max_new_tests_cap_avg, fill = who_testing_capacity), stat = "identity", position = "dodge") + 
  ylab('Maximum of 30-day average tests per 100k')+xlab('Country')+
  theme(axis.text.x = element_text(angle = 90)) + coord_flip() + ggtitle('Worst 25 LMICs Test capacity') + labs(fill = "WHO testing capacity")
bar_max_cap


test_df<-test_df[order(test_df$tpr_90_days),]
test_df<-test_df%>%filter(!is.na(tpr_90_days))
test_df$country<-factor(test_df$country, ordered = TRUE)
test_df_low_tpr<-test_df[1:25,]
test_df_high_tpr<-test_df[(nrow(test_df)-25):nrow(test_df),]
test_df_low_tpr$country <- factor(test_df_low_tpr$country, levels = test_df_low_tpr$country[order(-test_df_low_tpr$tpr_90_days)])
test_df_high_tpr$country <- factor(test_df_high_tpr$country, levels = test_df_high_tpr$country[order(-test_df_high_tpr$tpr_90_days)])

bar_low_tpr<-ggplot(test_df_low_tpr) + geom_bar(aes(x =country, y = tpr_90_days, fill = who_testing_capacity), stat = "identity", position = "dodge") + 
  ylab('Test positivity')+xlab('Country')+
  theme(axis.text.x = element_text(angle = 90)) + coord_flip() + ggtitle('Best 25 LMICs Test Positivity') + labs(fill = "WHO testing capacity")
bar_low_tpr

bar_high_tpr<-ggplot(test_df_high_tpr) + geom_bar(aes(x =country, y = tpr_90_days, fill = who_testing_capacity), stat = "identity", position = "dodge") + 
  ylab('Test positivity')+xlab('Country')+
  theme(axis.text.x = element_text(angle = 90)) + coord_flip() + ggtitle('Worst 25 LMICs Test Positivity') + labs(fill = "WHO testing capacity")
bar_high_tpr




```

```{r}
max_test_cap<-ggplot() + geom_histogram(data = test_df, aes(x= max_new_tests_cap_avg), fill = "magenta4", alpha = 0.4) + 
  geom_histogram(data = test_df, aes(x= old_max_new_tests_cap_avg), fill = "red4", alpha = 0.4) +
xlab('Maximum 30-day average oftests per 100k')+
geom_vline(xintercept = 50, linetype = "dashed", color = "gray")+
  scale_x_log10()+
  ylab('Frequency')
max_test_cap

pct_seq_v_tpr<-ggplot(test_df) + geom_point(aes(y = tpr_90_days, x = max_new_tests_cap_avg, color = factor(new_dx_testing_capacity),shape = old_dx_testing_capacity))+
    scale_x_log10()+
    geom_vline(xintercept = quartiles[1], linetype = "dashed")+
    geom_hline(yintercept = quartiles_tpr[5], linetype = "dashed") +
    coord_cartesian(ylim = c(0, 1))+
    xlab('Maximum of 30-day average of testing per 100k') + 
  ylab('Test positivity past 90 days')+ labs(shape = "Old diagnostic testing capacity", color = "New diagnostic testing capacity")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_tpr
```
```





How do the metrics compare with one another?
```{r}
#Per capita seq rate vs number of sequences 
n_v_rate<-ggplot(find_df) + geom_point(aes(x = total_sequences, y = per_capita_seq_rate, color = archetype))+
    scale_x_log10()+ scale_y_log10()+
    xlab('Total number of sequences') + ylab('Number of sequences in past 90 days per 100k')
n_v_rate

# Max 90 day avg of per capita seq vs per capita seq
max_v_rate<-ggplot(find_df) + geom_point(aes(x = max_new_seq_cap_avg, y = per_capita_seq_rate, color = archetype))+
    scale_x_log10()+ scale_y_log10()+
    xlab('Max 90-day avg per capita seq rate') + ylab('Number of sequences in past 90 days per 100k')
max_v_rate

# percent of cases sequenced vs per capita seq
pct_seq_v_rate<-ggplot(find_df) + geom_point(aes(x = percent_of_recent_cases_sequenced, y = per_capita_seq_rate, color = factor(archetype_clean)))+
                                                 scale_color_brewer(palette = "Set2")+
                                                    scale_x_log10()+ scale_y_log10()+
     geom_vline(xintercept = 0.5, linetype = "dashed")+
    geom_hline(yintercept = 0.75, linetype = "dashed") +
    xlab('Percent of recent cases sequenced') + ylab('Sequences in past 90 days per 100k')+labs(size = "cases in 90 days", color = "Original Archetype")
pct_seq_v_rate

# #recent sequences vs recent vases
# seq_v_cases<-ggplot(find_df) + geom_point(aes(y = per_capita_seq_rate, x = recent_cases_per_100k, color = factor(archetype_clean), 
#                                                  size = population_size))+
#                                                  scale_color_brewer(palette = "Set2")+
#                                                     scale_x_log10()+ scale_y_log10()+
#      #geom_vline(xintercept = 0.5, linetype = "dashed")+
#     #geom_hline(yintercept = 0.75, linetype = "dashed") +
#     xlab('Cases per 100k in 90 days') + ylab('Sequences per 100k in 90 days')+labs(size = "Population size (100k)", color = "Original Archetype")
# seq_v_cases

# percent of cases sequenced vs max 90 day avg seq rate
pct_seq_v_max<-ggplot(find_df) + geom_point(aes(y = max_new_seq_cap_avg, x = percent_of_recent_cases_sequenced, color = factor(archetype_clean)))+
    scale_x_log10()+ scale_y_log10()+
    geom_vline(xintercept = 0.5, linetype = "dashed")+
    geom_hline(yintercept = 0.1, linetype = "dashed") +
    xlab('Percent of recent cases sequenced') + ylab('Max 90-day avg per capita seq rate')+ labs(size = "cases in 90 days", color = "Original Archetype")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_max

# percent of cases sequenced vs max variant prevalence at detection
pct_seq_v_max_detect<-ggplot(find_df) + geom_point(aes(y = max_prevalence_variant_pct, x = percent_of_recent_cases_sequenced, color = factor(archetype_clean)))+
    scale_x_log10()+
    geom_vline(xintercept = 0.5, linetype = "dashed")+
    geom_hline(yintercept = 5, linetype = "dashed") +
    xlab('Percent of recent cases sequenced') + ylab('Max prevalence of variant at detection (%)')+ labs(size = "cases in 90 days", color = "Original Archetype")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_max_detect


# Testing vs sequencing
# percent of cases sequenced vs max variant prevalence at detection
pct_seq_v_tpr<-ggplot(find_df) + geom_point(aes(y = tpr_90_days, x = max_new_tests_cap_avg, color = factor(archetype_clean),shape = who_testing_capacity))+
    scale_x_log10()+
    geom_vline(xintercept = 50, linetype = "dashed")+
    geom_hline(yintercept = 0.05, linetype = "dashed") +
    coord_cartesian(ylim = c(0, 2))+
    xlab('Maximum of 30-day average of testing per 100k') + 
  ylab('Test positivity past 90 days')+ labs(shape = "WHO testing capacity", color = "Original Archetype")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_tpr
```

Density plots
```{r}
max_variant_prev<-ggplot(data = find_df, aes(x= max_prevalence_variant_pct)) + geom_density(fill = "purple") +
xlab('Maximum variant prevalence at detection')+
  ylab('Density')
max_variant_prev
max_variant_prev2<-ggplot(data = find_df, aes(x= max_prevalence_variant_pct)) + geom_histogram(fill = "purple") +
xlab('Maximum variant prevalence at detection (%)')+
  geom_vline(xintercept = 5, linetype = "dashed")+
  ylab('Frequency')
max_variant_prev2
pct_cases_sequenced<-ggplot(data = find_df, aes(x= percent_of_recent_cases_sequenced)) + geom_density(fill = "orange") +
xlab('Percent of recent cases sequenced')+
  scale_x_log10()+
  ylab('Density')
pct_cases_sequenced
path = "../out/pct_cases_seq_hist.png"
pct_cases_sequenced2<-ggplot(data = find_df, aes(x= percent_of_recent_cases_sequenced)) + geom_histogram(fill = "orange") +
xlab('Percent of recent cases sequenced')+
  geom_vline(xintercept = 0.5, linetype = "dashed")+
  scale_x_log10()+
  ylab('Frequency')
pct_cases_sequenced2
ggsave(filename = path,  device = png, dpi = 700)

max_seq_cap<-ggplot(data = find_df, aes(x= max_new_seq_cap_avg)) + geom_histogram(fill = "navy") +
xlab('Maximum of new sequences per 100k over a 90 day period')+
  #geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray")+
  scale_x_log10()+
  ylab('Frequency')
max_seq_cap

max_seq_cap<-ggplot(data = find_df, aes(x= max_prevalence_variant_pct)) + geom_histogram(fill = "purple") +
xlab('Maximum variant prevalence at detection')+
  #geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray")+
  scale_x_log10()+
  ylab('Frequency')
max_seq_cap

max_seq_cap<-ggplot(data = find_df, aes(x= per_capita_seq_rate)) + geom_histogram(fill = "green") +
xlab('Per capita sequencing rate')+
  #geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray")+
  scale_x_log10()+
  ylab('Frequency')
max_seq_cap



tpr_hist<-ggplot(data = find_df, aes(x= tpr_90_days)) + geom_histogram(fill = "cornflowerblue") +
xlab('Test positivity past 90 days')+
  geom_vline(xintercept = 0.05, linetype = "dashed")+
  scale_x_log10()+
  ylab('Frequency')
tpr_hist

max_test_hist<-ggplot(data = find_df, aes(x= max_new_tests_cap_avg)) + geom_histogram(fill = "magenta4") +
xlab('Maximum of 30-day average of daily new tests per 100k')+
  geom_vline(xintercept = 50, linetype = "dashed")+
  scale_x_log10()+
  ylab('Frequency')
max_test_hist

# sanity check
median_max_test_cap<-median(find_df$max_new_tests_cap_avg, na.rm = TRUE)
median_max_seq_cap<-median(find_df$max_new_seq_cap_avg, na.rm = TRUE)

```
QQ plots
```{r}
# Percent of recent cases sequenced
pct_seq_qq<-ggplot(data= find_df, aes(sample = log10(percent_of_recent_cases_sequenced))) + stat_qq() + stat_qq_line()+
ylab('Log of percent of recent cases sequenced') 
pct_seq_qq 

# Max variant prevalence at detection
max_detect_qq<-ggplot(data= find_df, aes(sample = max_prevalence_variant_pct)) + stat_qq() + stat_qq_line()+
ylab('Maximum variant prevalence at detection') 
max_detect_qq 


qqnorm(find_df$percent_of_recent_cases_sequenced, pch = 1, frame = FALSE)
qqline(find_df$percent_of_recent_cases_sequenced, col = "orange", lwd = 2)

# Number of sequences in past 90 days per capita
qqnorm(find_df$per_capita_seq_rate, pch = 1, frame = FALSE)
qqline(find_df$per_capita_seq_rate, col = "green", lwd = 2)

# Maximum 90 day avg of per capita seq rate
qqnorm(find_df$max_new_seq_cap_avg, pch = 1, frame = FALSE)
qqline(find_df$max_new_seq_cap_avg, col = "navy", lwd = 2)

```
Find some quartiles on the metrics
```{r}
# Find some quartiles on the metrics

quartiles_pct_cases_seq<-quantile(find_df$percent_of_recent_cases_sequenced, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
print(quartiles_pct_cases_seq)
quartiles_per_cap_seq<-quantile(find_df$per_capita_seq_rate, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
print(quartiles_per_cap_seq)
quartiles_max_avg_seq_rate<-quantile(find_df$max_new_seq_cap_avg, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
print(quartiles_max_avg_seq_rate)
# 
thirds_pct_cases_seq<-quantile(find_df$percent_of_recent_cases_sequenced, probs = c(0.33, 0.67), na.rm = TRUE)
print(thirds_pct_cases_seq)
thirds_per_cap_seq<-quantile(find_df$per_capita_seq_rate, probs = c(0.33, 0.67), na.rm = TRUE)
print(thirds_per_cap_seq)
thirds_max_avg_seq_rate<-quantile(find_df$max_new_seq_cap_avg, probs = c(0.33, 0.67), na.rm = TRUE)
print(thirds_max_avg_seq_rate)
```

Make categories based on the cut-offs 
```{r}

# Percent of cases sequenced
find_df<-find_df %>%
    mutate(
        pct_seq_cat = case_when(
            percent_of_recent_cases_sequenced == 0 ~ "0%",
            (percent_of_recent_cases_sequenced < 0.5 & percent_of_recent_cases_sequenced > 0)  ~ "<0.5%",
            percent_of_recent_cases_sequenced >= 0.5 ~ "0.5%+",
            is.na(percent_of_recent_cases_sequenced) == T ~ "0%"
        ),
      max_seq_cap_cat = case_when(
            max_new_seq_cap_avg == 0 ~ "0",
            max_new_seq_cap_avg > 0.05  ~ ">0.05",
            max_new_seq_cap_avg <= 0.05 & max_new_seq_cap_avg >0 ~ "0-0.05",
            is.na(max_new_seq_cap_avg) == T ~ "0"
        ),
      
      max_test_cap_cat = case_when(
        max_new_tests_cap_avg == 0 ~"0",
        max_new_tests_cap_avg >1 ~ ">1",
        max_new_tests_cap_avg <=1 & max_new_tests_cap_avg >0 ~ "0-1"
        
      ),
      max_variant_prev_cat = case_when(
          max_prevalence_variant_pct > 5  ~ "5%+",
          max_prevalence_variant_pct <= 5 ~ "<5%",
          is.na(max_prevalence_variant_pct) == T ~ "5%+"
        )
    )
```

Make new arcehtypes: First based on 
```{r}

find_df<-find_df %>%
  mutate(
    sequencing_data_level = case_when(
      (pct_seq_cat == "0.5%+") ~ "high",
      (pct_seq_cat == "<0.5%" ) ~ "medium",
      (pct_seq_cat == "0%") ~ "low"
    )
  )
find_df <- find_df %>%
  mutate(
    archetype_pct_cases_seq = case_when(
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "medium"  & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (dx_testing_capacity == "Unreliable testing capacity") ~ "Test"
    )
  )

arch_pct_seq_df<-find_df%>%
    group_by(archetype_pct_cases_seq)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"),
        median_n_sequences = median(total_sequences, na.rm = TRUE),
        median_sequences_per_100k = median(per_capita_seq_rate, na.rm = TRUE),
        median_percent_cases_seq = median(percent_of_recent_cases_sequenced, na.rm = TRUE),
        median_max_daily_seq_cap = median(max_new_seq_cap_avg, na.rm = TRUE))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )
find_df$archetype_pct_cases_seq<-factor(find_df$archetype_pct_cases_seq, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))
arch_pct_seq_df$archetype_pct_cases_seq<-factor(arch_pct_seq_df$archetype_pct_cases_seq, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))

bar_pct_seq<-ggplot(arch_pct_seq_df) + geom_bar(aes(x = factor(archetype_pct_cases_seq), y = pct_of_countries), stat = "identity", position = "dodge", fill = "orange") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio =1)+
    xlab('Archetype')+ ylab('Percent of LMICs') + ggtitle("Percent of recent cases sequenced")
bar_pct_seq

pct_seq_density_violin_archetype<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_pct_cases_seq), y = percent_of_recent_cases_sequenced), fill = "orange") +
    scale_y_log10()+
    geom_jitter(aes(x = factor(archetype_pct_cases_seq), y = percent_of_recent_cases_sequenced), height = 0, width = 0.4)+
    geom_hline(yintercept = 0.5, linetype = "dashed")+
    ylab('% of cases sequenced in the past 90 days') + xlab('Archetype') + ggtitle('Percent of recent cases sequenced')
pct_seq_density_violin_archetype
```
Archetype based on maximum of 90-day avg sequencing capacity
```{r}

find_df<-find_df %>%
  mutate(
    sequencing_data_level = case_when(
      (max_seq_cap_cat == ">0.05") ~ "high",
      (max_seq_cap_cat == "0-0.05" ) ~ "medium",
      (max_seq_cap_cat == "0") ~ "low"
    )
  )
find_df <- find_df %>%
  mutate(
    archetype_max_seq_cap = case_when(
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "medium"  & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (dx_testing_capacity == "Unreliable testing capacity") ~ "Test"
    )
  )

arch_max_seq_cap_df<-find_df%>%
    group_by(archetype_max_seq_cap)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"),
        median_n_sequences = median(total_sequences, na.rm = TRUE),
        median_sequences_per_100k = median(per_capita_seq_rate, na.rm = TRUE),
        median_percent_cases_seq = median(percent_of_recent_cases_sequenced, na.rm = TRUE),
        median_max_daily_seq_cap = median(max_new_seq_cap_avg, na.rm = TRUE))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )
find_df$archetype_max_seq_cap<-factor(find_df$archetype_max_seq_cap, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))
arch_max_seq_cap_df$archetype_max_seq_cap<-factor(arch_max_seq_cap_df$archetype_max_seq_cap, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))

bar_max_seq_cap<-ggplot(arch_max_seq_cap_df) + geom_bar(aes(x = factor(archetype_max_seq_cap), y = pct_of_countries), stat = "identity", position = "dodge", fill = "navy") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio =1)+
    xlab('Archetype')+ ylab('Percent of LMICs') + ggtitle("Maximum per capita sequencing")
bar_max_seq_cap

max_seq_density_violin_archetype<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_max_seq_cap), y = max_new_seq_cap_avg), fill = "navy") +
    scale_y_log10()+
    geom_jitter(aes(x = factor(archetype_max_seq_cap), y = max_new_seq_cap_avg), height = 0, width = 0.4, fill = "gray4")+
    geom_hline(yintercept = 0.05, linetype = "dashed")+
    ylab('Maximum per capita sequencing') + xlab('Archetype') + ggtitle('Maximum per capita sequencing')
max_seq_density_violin_archetype


pct_seq_v_max_seq<-ggplot(find_df) + geom_point(aes(y = max_new_seq_cap_avg, x = percent_of_recent_cases_sequenced, color = factor(archetype_pct_cases_seq), 
                                                shape = archetype_max_seq_cap))+
    scale_x_log10()+ scale_y_log10()+
    geom_vline(xintercept = 0.5, linetype = "dashed")+
    geom_hline(yintercept = 0.05, linetype = "dashed") +
    ylab('Maximum of per capita sequencing capacity') + xlab('Percent of recent cases sequenced')+ labs(shape = "Archetype max sequencing", color = "Archetype % cases sequenced")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_max_seq
```






```{r}


arch_pct_seq_df<-find_df%>%
    group_by(pct_seq_cat)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"),
        avg_n_sequences = mean(total_sequences, na.rm = TRUE),
        avg_sequences_per_100k = mean(per_capita_seq_rate, na.rm = TRUE),
        avg_percent_cases_seq = mean(percent_of_recent_cases_sequenced, na.rm = TRUE),
        avg_max_daily_seq_cap = mean(max_new_seq_cap_avg, na.rm = TRUE))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
find_df$pct_seq_cat<-factor(find_df$pct_seq_cat, ordered = TRUE, stringr::str_wrap(c("<0.5%", "0.5%+")))

bar_pct_seq<-ggplot(arch_pct_seq_df) + geom_bar(aes(x = factor(pct_seq_cat), y = pct_of_countries), stat = "identity", position = "dodge", fill = "orange") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio =1)+
    xlab('Percent of cases sequenced')+ ylab('Percent of countries')
bar_pct_seq


# Second grouping
arch_pct_seq_df2<-find_df%>%
    group_by(pct_seq_cat2)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"),
        avg_n_sequences = mean(total_sequences, na.rm = TRUE),
        avg_sequences_per_100k = mean(per_capita_seq_rate, na.rm = TRUE),
        avg_percent_cases_seq = mean(percent_of_recent_cases_sequenced, na.rm = TRUE),
        avg_max_daily_seq_cap = mean(max_new_seq_cap_avg, na.rm = TRUE))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
find_df$pct_seq_cat2<-factor(find_df$pct_seq_cat2, ordered = TRUE, stringr::str_wrap(c("0%", "<0.5%", "0.5%+")))
arch_pct_seq_df2$pct_seq_cat2<-factor(arch_pct_seq_df2$pct_seq_cat2, ordered = TRUE, stringr::str_wrap(c("0%", "<0.5%", "0.5%+")))

bar_pct_seq2<-ggplot(arch_pct_seq_df2) + geom_bar(aes(x = factor(pct_seq_cat2), y = pct_of_countries), stat = "identity", position = "dodge", fill = "orange") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio =1)+
    xlab('Percent of cases sequenced')+ ylab('Percent of countries')
bar_pct_seq2

# group by max variant prevalence at detection
arch_max_prev_detect_df<-find_df%>%
    group_by(max_variant_prev_cat)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"),
        avg_n_sequences = mean(total_sequences, na.rm = TRUE),
        avg_sequences_per_100k = mean(per_capita_seq_rate, na.rm = TRUE),
        avg_percent_cases_seq = mean(percent_of_recent_cases_sequenced, na.rm = TRUE),
        avg_max_daily_seq_cap = mean(max_new_seq_cap_avg, na.rm = TRUE))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
arch_max_prev_detect_df$max_variant_prev_cat<-factor(arch_max_prev_detect_df$max_variant_prev_cat, ordered = TRUE, stringr::str_wrap(c("5%+", "<5%")))

bar_max_prev<-ggplot(arch_max_prev_detect_df) + geom_bar(aes(x = factor(max_variant_prev_cat), y = pct_of_countries), stat = "identity", position = "dodge", fill = "purple") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio =1)+
    xlab('Max variant prevalence at detection')+ ylab('Percent of countries')
bar_max_prev

```
Make new archetypes
```{r}
# Percent of recent cases sequenced & max variant prevalence at detection 
# high sequencing data availability: >0.5% cases sequenced, max variant prevalence at detection <5%
# medium sequencing data availability: <0.5% cases sequenced, max variant prevalence at detection <5% |
                            # >0.5% cases sequenced, max varian prevalence at detection >5%
# low sequencing data availability: <0.5% cases sequenced, max variant prevalence at detection >5%

find_df<-find_df %>%
  mutate(
    sequencing_data_level = case_when(
      (pct_seq_cat == "0.5%+" & max_variant_prev_cat == "<5%") ~ "high",
      ((pct_seq_cat == "<0.5%" & max_variant_prev_cat == "<5%") | (pct_seq_cat == "0.5%+" & max_variant_prev_cat == "5%+")) ~ "medium",
      (pct_seq_cat == "<0.5%" & max_variant_prev_cat == "5%+") ~ "low"
    )
  )
```

Make new archetypes
```{r}
# Percent of recent cases sequenced & max variant prevalence at detection 
# high sequencing data availability: >0.5% cases sequenced, max variant prevalence at detection <5%
# medium sequencing data availability: <0.5% cases sequenced, max variant prevalence at detection <5% |
                            # >0.5% cases sequenced, max varian prevalence at detection >5%
# low sequencing data availability: <0.5% cases sequenced, max variant prevalence at detection >5%

find_df<-find_df %>%
  mutate(
    sequencing_data_level = case_when(
      (pct_seq_cat2 == "0.5%+") ~ "high",
      (pct_seq_cat2 == "<0.5%" ) ~ "medium",
      (pct_seq_cat2 == "0%") ~ "low"
    )
  )
```

```{r}

find_df <- find_df %>%
  mutate(
    archetype_new = case_when(
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "high" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "medium" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "medium"  & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & sequencing_data_level == "low" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (dx_testing_capacity == "Unreliable testing capacity") ~ "Test"
    )
  )
# order the archetypes
find_df$archetype_new<-factor(find_df$archetype_new, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))
```

 Archetypes and metrics
```{r}
pct_seq_density_violin_archetype<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_new), y = percent_of_recent_cases_sequenced), fill = "orange") +
    scale_y_log10()+
    geom_jitter(aes(x = factor(archetype_new), y = percent_of_recent_cases_sequenced), height = 0, width = 0.4)+
    geom_hline(aes(yintercept = 0.05), linetype = "dashed") +
    ylab('% of cases sequences in the past 90 days') + xlab('New archetype')
pct_seq_density_violin_archetype


per_cap_seq_rate_archetype<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_new), y = per_capita_seq_rate), fill = "green") +
    scale_y_log10()+
    geom_jitter(aes(x = factor(archetype_new), y = per_capita_seq_rate), height = 0, width = 0.4)+
    ylab('Sequences in the past 90 days per 100k') + xlab('Per capita seq archetype')
per_cap_seq_rate_archetype


max_seq_cap_arch<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_new), y = max_new_seq_cap_avg), fill = "navy") +
    scale_y_log10()+
    geom_jitter(aes(x = factor(archetype_new), y = max_new_seq_cap_avg), height = 0, width = 0.4)+
    ylab('Maximum 90-day avg of per capita seq rate') + xlab('New archetype')
max_seq_cap_arch

max_prev_detect_arch<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_new), y = max_prevalence_variant_pct), fill = "purple") +
    scale_y_log10()+
    geom_hline(aes(yintercept = 5), linetype = "dashed") +
    geom_jitter(aes(x = factor(archetype_new), y = max_prevalence_variant_pct), height = 0, width = 0.4)+
    ylab('Maximum prevalence at detection') + xlab('New archetype')
max_prev_detect_arch

# percent of cases sequenced vs max variant prevalence at detection
pct_seq_v_max_detect<-ggplot(find_df) + geom_point(aes(y = max_prevalence_variant_pct, x = percent_of_recent_cases_sequenced, color = factor(archetype_new)))+
    scale_x_log10()+
    geom_vline(xintercept = 0.5, linetype = "dashed")+
    geom_hline(yintercept = 5, linetype = "dashed") +
    xlab('Percent of recent cases sequenced') + ylab('Max prevalence of variant at detection (%)')+ labs(size = "cases in 90 days", color = "New Archetype")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_max_detect

pct_seq_v_max_detect2<-ggplot(find_df) + geom_point(aes(y = max_prevalence_variant_pct, x = percent_of_recent_cases_sequenced, color = factor(archetype_clean)))+
    scale_x_log10()+
    geom_vline(xintercept = 0.5, linetype = "dashed")+
    geom_hline(yintercept = 5, linetype = "dashed") +
    xlab('Percent of recent cases sequenced') + ylab('Max prevalence of variant at detection (%)')+ labs(size = "cases in 90 days", color = "Original Archetype")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_max_detect2
```


Summary statistics on the archetypes
```{r}
orig_summary<-find_df%>%
    group_by(archetype_clean)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

bar_orig<-ggplot(orig_summary) + geom_bar(aes(x = factor(archetype_clean), y = pct_of_countries), stat = "identity", position = "dodge", fill = "blue4") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio = 1)+
    xlab('Original archetype')+ ylab('Percent of countries')
bar_orig
new_summary<-find_df%>%
    group_by(archetype_new)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
new_summary$archetype_new<-factor(new_summary$archetype_new, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))

bar_new<-ggplot(new_summary) + geom_bar(aes(x = factor(archetype_new), y = pct_of_countries), stat = "identity", position = "dodge", fill = "darkgreen") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio = 1)+
    xlab('New archetype')+ ylab('Percent of countries')
bar_new


full_map_df<-full_join(map_df, find_df, by = "code")
map6<- ggplot(data = full_map_df, aes(x = long, y = lat)) + 
    geom_polygon(aes(group = group, fill = archetype_new)) +
    theme(legend.position = "bottom", legend.key.width = unit(2.1, "cm")) + 
    scale_x_discrete(labels = NULL, breaks = NULL) +
    scale_y_discrete(labels = NULL, breaks = NULL) +
    labs(x = "", y = "", fill = "")+
    scale_fill_manual(values = c("plum", "orchid3", "darkorchid3", "darkorchid4"),name = "")+
  ggtitle("New archetype")
map6
map7<- ggplot(data = full_map_df, aes(x = long, y = lat)) + 
    geom_polygon(aes(group = group, fill = archetype_clean)) +
    theme(legend.position = "bottom", legend.key.width = unit(2.1, "cm")) + 
    scale_x_discrete(labels = NULL, breaks = NULL) +
    scale_y_discrete(labels = NULL, breaks = NULL) +
    labs(x = "", y = "", fill = "")+
    scale_fill_manual(values = c("plum", "orchid3", "darkorchid3", "darkorchid4"),name = "")+
  ggtitle("Original archetype")
map7

N_sequences<- log(1-0.95)/log(1-0.05)
```












```{r}
# Per capita sequencing rate
find_df<-find_df %>%
    mutate(
        # <0.034 | NA
        # 0.034-3.2
        # 3.2+
        per_cap_seq_cat = case_when(
            per_capita_seq_rate < thirds_per_cap_seq[1]  ~ "<0.034 per 100k",
            per_capita_seq_rate< thirds_per_cap_seq[2] & per_capita_seq_rate >= thirds_per_cap_seq[1] ~ "0.034-3.2 per 100k",
            per_capita_seq_rate >= thirds_per_cap_seq[2] ~ "3.2+ per 100k",
            is.na(per_capita_seq_rate) == T ~ "<0.034 per 100k"
        )
    )


arch_per_cap_seq_df<-find_df%>%
    group_by(per_cap_seq_cat)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"),
        avg_n_sequences = mean(total_sequences),
        avg_sequences_per_100k = mean(per_capita_seq_rate, na.rm = TRUE),
        avg_percent_cases_seq = mean(percent_of_recent_cases_sequenced, na.rm = TRUE),
        avg_max_daily_seq_cap = mean(max_new_seq_cap_avg, na.rm = TRUE)
        )%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
find_df$per_cap_seq_cat<-factor(find_df$per_cap_seq_cat, ordered = TRUE, stringr::str_wrap(c("<0.034 per 100k", "0.034-3.2 per 100k", "3.2+ per 100k")))

bar_per_cap_seq<-ggplot(arch_per_cap_seq_df) + geom_bar(aes(x = factor(per_cap_seq_cat), y = pct_of_countries), stat = "identity", position = "dodge", fill = "green") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio =1)+
    xlab('Per capita sequencing in the past 90 days')+ ylab('Percent of countries')
bar_per_cap_seq



# Maximum 90-day average daily per capita sequencing rate
find_df<-find_df %>%
    mutate(
        # <0.018 | NA
        # 0.018- 0.19
        # 0.19+
        max_seq_cat = case_when(
            max_new_seq_cap_avg < thirds_max_avg_seq_rate[1]  ~ "<0.018 moving avg per 100k",
            max_new_seq_cap_avg< thirds_max_avg_seq_rate[2] & thirds_max_avg_seq_rate >= thirds_max_avg_seq_rate[1] ~ "0.018-0.19 moving avg per 100k",
            max_new_seq_cap_avg >= thirds_max_avg_seq_rate[2] ~ "0.19+ moving avg per 100k",
            is.na(max_new_seq_cap_avg) == T ~ "<0.018 moving avg per 100k"
        )
    )


arch_seq_cap_df<-find_df%>%
    group_by(max_seq_cat)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"),
        avg_n_sequences = mean(total_sequences),
        avg_sequences_per_100k = mean(per_capita_seq_rate, na.rm = TRUE),
        avg_percent_cases_seq = mean(percent_of_recent_cases_sequenced, na.rm = TRUE),
        avg_max_daily_seq_cap = mean(max_new_seq_cap_avg, na.rm = TRUE))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
find_df$max_seq_cat<-factor(find_df$max_seq_cat, ordered = TRUE, stringr::str_wrap(c("<0.018 moving avg per 100k", "0.018-0.19 moving avg per 100k", "0.19+ moving avg per 100k")))

bar_per_cap_seq<-ggplot(arch_per_cap_seq_df) + geom_bar(aes(x = factor(per_cap_seq_cat), y = pct_of_countries), stat = "identity", position = "dodge", fill = "navy") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio = 1)+
    xlab('Maximum 90-day moving average of new sequences per 100k')+ ylab('Percent of countries')
bar_per_cap_seq
```

Make new archetypes
```{r}
# Percent of recent cases sequenced
find_df <- find_df %>%
  mutate(
    archetype_pct_cases_seq = case_when(
      (sequencing_capacity == "4+ NGS facilities or equivalent" & pct_seq_cat == "0.57%+" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "4+ NGS facilities or equivalent" &  pct_seq_cat == "0.57%+" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & pct_seq_cat == "0.02-0.57%" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & pct_seq_cat == "0.02-0.57%" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & pct_seq_cat == "<0.02%" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & pct_seq_cat == "<0.02%" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & pct_seq_cat == "0.57%+" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & pct_seq_cat == "0.57%+" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & pct_seq_cat == "0.02-0.57%" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & pct_seq_cat == "0.02-0.57%" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" &  pct_seq_cat == "<0.02%" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & pct_seq_cat == "<0.02%" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" &  pct_seq_cat == "0.57%+" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "0 NGS facilities or equivalent" & pct_seq_cat == "0.57%+" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & pct_seq_cat == "0.02-0.57%" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & pct_seq_cat == "0.02-0.57%"  & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & pct_seq_cat == "<0.02%" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & pct_seq_cat == "<0.02%"& dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (dx_testing_capacity == "Unreliable testing capacity") ~ "Test"
    )
  )
# order the archetypes
find_df$archetype_pct_cases_seq<-factor(find_df$archetype_pct_cases_seq, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))

# Per capita sequencing in the past 90 days
find_df <- find_df %>%
  mutate(
    archetype_per_cap_seq = case_when(
       (sequencing_capacity == "4+ NGS facilities or equivalent" & per_cap_seq_cat == "3.2+ per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & per_cap_seq_cat == "3.2+ per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & per_cap_seq_cat== "0.034-3.2 per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & per_cap_seq_cat== "0.034-3.2 per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & per_cap_seq_cat== "<0.034 per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & per_cap_seq_cat== "<0.034 per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & per_cap_seq_cat == "3.2+ per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & per_cap_seq_cat == "3.2+ per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & per_cap_seq_cat== "0.034-3.2 per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & per_cap_seq_cat== "0.034-3.2 per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & per_cap_seq_cat== "<0.034 per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & per_cap_seq_cat== "<0.034 per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & per_cap_seq_cat == "3.2+ per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "0 NGS facilities or equivalent" & per_cap_seq_cat == "3.2+ per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & per_cap_seq_cat== "0.034-3.2 per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & per_cap_seq_cat== "0.034-3.2 per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & per_cap_seq_cat== "<0.034 per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & per_cap_seq_cat== "<0.034 per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (dx_testing_capacity == "Unreliable testing capacity") ~ "Test"
    )
  )

# order the archetypes
find_df$archetype_per_cap_seq<-factor(find_df$archetype_per_cap_seq, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))
# Maximum 90 day daily rolling avg per capita sequencing over entire pandemic
find_df <- find_df %>%
  mutate(
    archetype_max_avg_seq = case_when(
      (sequencing_capacity == "4+ NGS facilities or equivalent" & max_seq_cat == "0.19+ moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & max_seq_cat == "0.19+ moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & max_seq_cat== "0.018-0.19 moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & max_seq_cat== "0.018-0.19 moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & max_seq_cat== "<0.018 moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "4+ NGS facilities or equivalent" & max_seq_cat== "<0.018 moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & max_seq_cat == "0.19+ moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Strengthen",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & max_seq_cat == "0.19+ moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & max_seq_cat== "0.018-0.19 moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & max_seq_cat== "0.018-0.19 moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & max_seq_cat== "<0.018 moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "1-3 NGS facilities or equivalent" & max_seq_cat== "<0.018 moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & max_seq_cat == "0.19+ moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Leverage",
      (sequencing_capacity == "0 NGS facilities or equivalent" & max_seq_cat == "0.19+ moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & max_seq_cat== "0.018-0.19 moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & max_seq_cat== "0.018-0.19 moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (sequencing_capacity == "0 NGS facilities or equivalent" & max_seq_cat== "<0.018 moving avg per 100k" & dx_testing_capacity == "Reliable testing capacity") ~ "Connect",
      (sequencing_capacity == "0 NGS facilities or equivalent" & max_seq_cat== "<0.018 moving avg per 100k" & dx_testing_capacity == "Unreliable testing capacity") ~ "Test",
      (dx_testing_capacity == "Unreliable testing capacity") ~ "Test"
    )
  )
# order the archetypes
find_df$archetype_max_avg_seq<-factor(find_df$archetype_max_avg_seq, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))

```
 Archetypes and metrics
```{r}
pct_seq_density_violin_archetype<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_pct_cases_seq), y = percent_of_recent_cases_sequenced), fill = "orange") +
    scale_y_log10()+
    geom_jitter(aes(x = factor(archetype_pct_cases_seq), y = percent_of_recent_cases_sequenced), height = 0, width = 0.4)+
    geom_hline(aes(yintercept = thirds_pct_cases_seq[1]), linetype = "dashed") +
    geom_hline(aes(yintercept = thirds_pct_cases_seq[2]), linetype = "dashed") +
    ylab('% of cases sequences in the past 90 days') + xlab('% cases sequenced archetype')
pct_seq_density_violin_archetype


per_cap_seq_rate_archetype<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_per_cap_seq), y = per_capita_seq_rate), fill = "green") +
    scale_y_log10()+
    geom_hline(aes(yintercept = thirds_per_cap_seq[1]), linetype = "dashed") +
    geom_hline(aes(yintercept = thirds_per_cap_seq[2]), linetype = "dashed") +
    geom_jitter(aes(x = factor(archetype_per_cap_seq), y = per_capita_seq_rate), height = 0, width = 0.4)+
    ylab('Sequences in the past 90 days per 100k') + xlab('Per capita seq archetype')
per_cap_seq_rate_archetype


max_seq_cap_arch<-ggplot(find_df) + geom_violin(aes(x = factor(archetype_max_avg_seq), y = max_new_seq_cap_avg), fill = "navy") +
    scale_y_log10()+
    geom_hline(aes(yintercept = thirds_max_avg_seq_rate[1]), linetype = "dashed") +
    geom_hline(aes(yintercept = thirds_max_avg_seq_rate[2]), linetype = "dashed") +
    geom_jitter(aes(x = factor(archetype_max_avg_seq), y = max_new_seq_cap_avg), height = 0, width = 0.4)+
    ylab('Maximum 90-day avg of per capita seq rate') + xlab('Maximum 90 day daily per capita avg sequencing archetype')
max_seq_cap_arch
```



Original and 3 proposed new archetypes
```{r}
orig_summary<-find_df%>%
    group_by(archetype_clean)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

bar_orig<-ggplot(orig_summary) + geom_bar(aes(x = factor(archetype_clean), y = pct_of_countries), stat = "identity", position = "dodge", fill = "purple") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio = 1)+
    xlab('Original archetype')+ ylab('Percent of countries')
bar_orig

pct_cases_summary<-find_df%>%
    group_by(archetype_pct_cases_seq)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
pct_cases_summary$archetype_pct_cases_seq<-factor(pct_cases_summary$archetype_pct_cases_seq, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))

bar_orig<-ggplot(pct_cases_summary) + geom_bar(aes(x = factor(archetype_pct_cases_seq), y = pct_of_countries), stat = "identity", position = "dodge", fill = "orange") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio = 1)+
    xlab('Percent of cases sequenced archetype')+ ylab('Percent of countries')
bar_orig

per_cap_summary<-find_df%>%
    group_by(archetype_per_cap_seq)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
per_cap_summary$archetype_per_cap_seq<-factor(per_cap_summary$archetype_per_cap_seq, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))


bar_per_cap<-ggplot(per_cap_summary) + geom_bar(aes(x = factor(archetype_per_cap_seq), y = pct_of_countries), stat = "identity", position = "dodge", fill = "green") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio = 1)+
    xlab('Per capita sequence archetype')+ ylab('Percent of countries')
bar_per_cap

max_seq_summary<-find_df%>%
    group_by(archetype_max_avg_seq)%>%
    summarise(
        n_countries = n(),
        n_LMIC = sum(LMIC_status == "LMIC"))%>%
    mutate(
        pct_of_LMICs = n_LMIC/sum(n_LMIC),
        pct_of_countries = 100*n_countries/sum(n_countries)
    )

# order the archetypes
max_seq_summary$archetype_max_avg_seq<-factor(max_seq_summary$archetype_max_avg_seq, ordered = TRUE, stringr::str_wrap(c("Test", "Connect", "Leverage", "Strengthen")))


bar_max_avg<-ggplot(max_seq_summary) + geom_bar(aes(x = factor(archetype_max_avg_seq), y = pct_of_countries), stat = "identity", position = "dodge", fill = "navy") +
    theme(axis.text.x = element_text(angle=45, hjust =1),
          aspect.ratio = 1)+
    xlab('Max sequencing rate archetype')+ ylab('Percent of countries')
bar_max_avg


```
Archetype comparison
```{r}

# percent of cases sequenced vs max 90 day avg seq rate
pct_seq_v_max<-ggplot(find_df) + geom_point(aes(y = max_new_seq_cap_avg, x = percent_of_recent_cases_sequenced, color = factor(archetype_clean), size = recent_cases, shape = factor(archetype_per_cap_seq)))+
    scale_x_log10()+ scale_y_log10()+
    geom_vline(xintercept = 0.5, linetype = "dashed")+
    geom_hline(yintercept = 0.1, linetype = "dashed") +
    xlab('Percent of recent cases sequenced') + ylab('Max 90-day avg per capita seq rate')+ labs(size = "cases in 90 days", color = "Original Archetype", shape = "New Archetype")+
    scale_color_brewer(palette = "Set2")
pct_seq_v_max
```
